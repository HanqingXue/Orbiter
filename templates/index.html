<!doctype html>
<html lang="en">
	<head>
		<title>North Korea Missile Test Visualization</title>
		<meta charset="utf-8">
		<meta name="description" content="An interactive visualization of flight tests of all missiles launched by North Korea from 1984 to 2017. This data visualization was produced by Akihiko Kusanagi. The data for this visualization are sourced from the CNS North Korea Missile Test Database.">
		<meta name="viewport" content="user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1">
		<meta name="twitter:card" content="summary_large_image">
		<meta name="twitter:site" content="@nagix">
		<meta property="og:title" content="North Korea Missile Test Visualization">
		<meta property="og:description" content="An interactive visualization of flight tests of all missiles launched by North Korea from 1984 to 2017. This data visualization was produced by Akihiko Kusanagi. The data for this visualization are sourced from the CNS North Korea Missile Test Database.">
		<meta property="og:url" content="https://nagix.github.io/nk-missile-tests/">
		<meta property="og:image" content="https://nagix.github.io/nk-missile-tests/images/screenshot.jpg">
		<link rel="stylesheet" type="text/css" href="{{ static_url('css/style.css') }}">

	</head>

	<body onload="start()" id="dataviz" class="">
		<div id="wrapper">
		<div id="loading">
			<h2>Loading North Korea Missile Test Data from 1984 to 2017. Please wait...</h2>
		</div>

		<div >
			<table id="marker_template" class="marker" style="left:'0px';top:'0px'">
				<tr><td><span id="testText" class="test"></span><div class="close"></div></td></tr>
				<tr><td><span id="detailText" class="detail"></span></td></tr>
				<tr><td><span id="descriptionText" class="description"></span></td></tr>
			</table>
		</div>

		<div id="visualization" >
			<!-- 2D overlay elements go in here -->

			<div id="glContainer">
				<!-- 3D webgl canvas here -->
			</div>
		</div>

		<script src="{{ static_url('js/Detector.js') }}"></script>
		<script src="{{ static_url('js/three-r87.min.js') }}"></script>
		<script src="{{ static_url('js/THREEx.KeyboardState.js') }}"></script>
		<script src="{{ static_url('js/THREEx.WindowResize.js') }}"></script>
		<script src="{{ static_url('js/jquery-3.2.1.min.js') }}"></script>
		<script src="{{ static_url('js/jquery-ui-1.12.1.custom') }}.min.js"></script>
		<script src="{{ static_url('js/RequestAnimationFrame.js') }}"></script>
		<script src="{{ static_url('js/ShaderExtras.js') }}"></script>

		<script src="{{ static_url('js/util.js') }}"></script>
		<script src="{{ static_url('js/mousekeyboard.js') }}"></script>
		<script src="{{ static_url('js/dataloading.js') }}"></script>
		<script src="{{ static_url('js/geopins.js') }}"></script>
		<script src="{{ static_url('js/visualize.js') }}"></script>
		<script src="{{ static_url('js/visualize_lines.js') }}"></script>
		<script src="{{ static_url('js/markers.js') }}"></script>
		<script src="{{ static_url('js/d3-4.11.0.min.js') }}"></script>
		<script src="{{ static_url('js/ui.controls.js') }}"></script>
		<script src="{{ static_url('js/hammer-2.0.8.min.js') }}"></script>

		<script type="x-shader/x-vertex" id="vertexshader">
			uniform float amplitude;
			attribute float size;
			attribute vec3 customColor;

			varying vec3 vColor;

			void main() {

				vColor = customColor;

				vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );

				gl_PointSize = size;

				gl_Position = projectionMatrix * mvPosition;

			}
		</script>

		<script type="x-shader/x-fragment" id="fragmentshader">
			uniform vec3 color;
			uniform sampler2D texture;

			varying vec3 vColor;

			void main() {

				gl_FragColor = vec4( color * vColor, 1.0 );
				gl_FragColor = gl_FragColor * texture2D( texture, gl_PointCoord );

			}
		</script>

		<!-- Custom Shader Code for atmospheric glow -->
		<script type="x-shader/x-vertex" id="vertexShaderAtmosphere">
			varying vec3 vNormal;
			varying vec3 vPosition;

			void main() {
				vNormal = normalize( normalMatrix * normal );
				vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
				vPosition = normalize( vec3( mvPosition.x, mvPosition.y, mvPosition.z ) );
				gl_Position = projectionMatrix * mvPosition;
			}
		</script>

		<!-- fragment shader a.k.a. pixel shader -->
		<script type="x-shader/x-vertex" id="fragmentShaderAtmosphere">
			varying vec3 vNormal;
			varying vec3 vPosition;

			void main() {
				float intensity = dot( vNormal, vPosition ) * 2.5 - 1.92;
				gl_FragColor = vec4( 1.0, 1.0, 1.0, 1.0 ) * intensity;
			}
		</script>

		<script src="{{ static_url('js/main.js') }}" type="text/javascript"></script>

		<script type="text/javascript">
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

			ga('create', 'UA-39988758-2', 'auto');
			ga('send', 'pageview');
		</script>


		<!-- All other hud can go here-->
		<div id="hudHeader" class="overlayTests noPointer">
			<h1 class="noPointer">
				<div class="title">North Korea Missile Test Visualization</div>
				<div class="subtitle">An interactive visualization of flight tests of all missiles launched by North Korea from 1984 to 2017</div>
			</h1>
		</div>

		<div class="overlayTests noPointer" id="hudButtons">
			<div class="hudButtonGroup">
				<input type="button" value="SEARCH" class="searchBtn testsBtn pointer"><br />
				<input type="button" value="ABOUT" class="aboutBtn testsBtn pointer">
			</div>
			<input type="text" name="test" class="testTextInput pointer noMapDrag">
			<div class="hudButtonGroup">
				<input type="button" class="tiltBtn topViewBtn testsBtn pointer noMapDrag"><br />
				<input type="button" class="tiltBtn sideViewBtn testsBtn pointer noMapDrag">
			</div>
			<div class="hudButtonGroup">
				<input type="button" value="+" class="zoomBtn zoomInBtn testsBtn pointer noMapDrag"><br />
				<input type="button" value="â€”" class="zoomBtn zoomOutBtn testsBtn pointer noMapDrag">
			</div>
			<div id="hudButtonHandle" class="pointer noMapDrag"></div>
		</div>
		<div id="history" class="overlayTests noPointer">
			<div class="graph">
				<div class="close"></div>
				<div class="labels">
					<div class="outcome">TEST OUTCOME</div>
					<div class="unknowns">UNKNOWN</div>
					<div class="failures">FAILURE</div>
					<div class="successes">SUCCESS</div><br class="clear" />
				</div>
				<div class="container noPointer"></div>
			</div>
			<ul class="timeline pointer">
				<li class="wide">1984</li><li class="narrow">1984</li>
				<li class="wide">1986</li><li class="narrow">86</li>
				<li class="wide">1990</li><li class="narrow">90</li>
				<li class="wide">1991</li><li class="narrow">91</li>
				<li class="wide">1992</li><li class="narrow">92</li>
				<li class="wide">1993</li><li class="narrow">93</li>
				<li class="wide">1998</li><li class="narrow">98</li>
				<li class="wide">2006</li><li class="narrow">2006</li>
				<li class="wide">2009</li><li class="narrow">09</li>
				<li class="wide">2012</li><li class="narrow">12</li>
				<li class="wide">2013</li><li class="narrow">13</li>
				<li class="wide">2014</li><li class="narrow">14</li>
				<li class="wide">2015</li><li class="narrow">15</li>
				<li class="wide">2016</li><li class="narrow">16</li>
				<li class="wide">2017</li><li class="narrow">2017</li>
				<div id="handle" class="noMapDrag"></div>
			</ul>
		</div>
		<div id="graphIcon" class="overlayTests"></div>
		<div id="outcomeBtns" class="overlayTests">
			<div class="success">
				<div class="label">Success</div><br class="clear">
			</div>
			<div class="failure">
				<div class="label">Failure</div><br class="clear">
			</div>
			<div class="unknown">
				<div class="label">Unknown</div><br class="clear">
			</div>
			<br class="clear" />
		</div>
		<div id="missileTypeBtns" class="overlayTests">
			<div class="er-scud">
				<div class="box">
					<svg class="check" height="16" width="16">
						<defs>
							<g id="checkbutton">
								<circle r="8" cy="8" cx="8" style="stroke:none" />
								<path d="M 3.6801386,8.536309 L 6.9552837,11.971756 L 12.41386,3.9557141" style="fill:none;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round" />
							</g>
						</defs>
						<use xlink:href="#checkbutton" />
					</svg>
				</div>
				<div class="label">ER Scud</div><br class="clear">
			</div>
			<div class="hwasong-12">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">Hwasong-12</div><br class="clear">
			</div>
			<div class="hwasong-14">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">Hwasong-14</div><br class="clear">
			</div>
			<div class="hwasong-15">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">Hwasong-15</div><br class="clear">
			</div>
			<div class="kn-02">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">KN-02</div><br class="clear">
			</div>
			<div class="musudan">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">Musudan</div><br class="clear">
			</div>
			<div class="nodong">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">Nodong</div><br class="clear">
			</div>
			<div class="polaris-1">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">Polaris-1</div><br class="clear">
			</div>
			<div class="polaris-2">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">Polaris-2</div><br class="clear">
			</div>
			<div class="scud-b">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">Scud-B</div><br class="clear">
			</div>
			<div class="scud-b-marv">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">Scud-B MaRV</div><br class="clear">
			</div>
			<div class="scud-c">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">Scud-C</div><br class="clear">
			</div>
			<div class="scud-c-marv">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">Scud-C MaRV</div><br class="clear">
			</div>
			<div class="taepodong-1">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">Taepodong-1</div><br class="clear">
			</div>
			<div class="unha">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">Unha</div><br class="clear">
			</div>
			<div class="unha-3">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">Unha-3</div><br class="clear">
			</div>
			<div class="unknown">
				<div class="box">
					<svg class="check" height="16" width="16"><use xlink:href="#checkbutton" /></svg>
				</div>
				<div class="label">Unknown</div><br class="clear">
			</div>
		</div>

		<div id="aboutContainer" class="overlayTests">
			<div class="arrowUp"></div>
			<div id="aboutBox">
				<div class="title">Information about the data</div>
				<div class="text">
					This data visualization was produced by <a href="https://nagix.github.io/" target="_blank">Akihiko Kusanagi</a>. The data for this visualization are sourced from <a href="http://www.nti.org/analysis/articles/cns-north-korea-missile-test-database/" target="_blank">the CNS North Korea Missile Test Database</a>, which is the first database to record flight tests of all missiles launched by North Korea capable of delivering a payload of at least 500 kilograms (1102.31 pounds) a distance of at least 300 kilometers (186.4 miles). The database captures advancements in North Korea's missile program by documenting all such tests since the first one occurred in April 1984, and will be routinely updated as events warrant.<br /><br />For more info and source code, please see the <a href="https://github.com/nagix/nk-missile-tests" target="_blank">GitHub repository</a>.
				</div>
			</div>
		</div>
	</div>
	</body>
</html>
<script type="text/javascript">
		var masterContainer = document.getElementById('visualization');

		var mapOutlineImage;		

		//	where in html to hold all our things
		var glContainer = document.getElementById( 'glContainer' );
		var dpr = window.devicePixelRatio ? window.devicePixelRatio : 1;		

		var lang = getLang();
		var dict;

		//	contains a list of facility codes with their matching facility names
		var facilityFile = "{{ static_url('data/facility.en.json') }}"
		//var facilityFile = 'data/facility.' + lang + '.json';
		//var missileFile = 'data/missile.' + lang + '.json';
		var missileFile = "{{ static_url('data/missile.en.json') }}"	
		//var dictFile = 'data/dict.' + lang + '.json';	
		var dictFile = "{{ static_url('data/dict.en.json') }}"	

		var camera, scene, renderer;
		var camera2s, scene2d;		

		var sphere;
		var rotating;
		var visualizationMesh;

//	contains the data loaded from the test data file
//	contains a list of years, followed by tests within that year
	var timeBins;	

	//	contains latlon data for each facility
	var latlonData;	

	//	contains above but organized as a mapped list via ['facilityname'] = facilityobject
	//	each facility object has data like center of facility in 3d space, lat lon and facility name
	var facilityData = new Object();
	var testData = new Object();	

	//	contains a list of missile code to missile name for running lookups
	var missileLookup;	

	var yearIndexLookup = {};
	var selectableTests = [];
	var summary;	

	//	a list of outcome 'codes'
	//	now they are just strings of categories
	//	Outcome Code : Outcome Node
	var outcomeLookup = {
		'success': 'Success',
		'failure': 'Failure',
		'unknown': 'Unknown'
	};	

	//	A list of missile colors
	var missileColors = {
		'er-scud' : 0x1A62A5,
		'hwasong-12' : 0x6C6C6C,
		'hwasong-14' : 0xAEB21A,
		'hwasong-15' : 0x1DB2C4,
		'kn-02': 0xB68982,
		'musudan': 0x9FBAE3,
		'nodong': 0xFD690F,
		'polaris-1': 0xFEAE65,
		'polaris-2': 0xDA5CB6,
		'scud-b': 0x279221,
		'scud-b-marv': 0xD2D479,
		'scud-c': 0x89DC78,
		'scud-c-marv': 0xBBBBBB,
		'taepodong-1': 0xCA0F1E,
		'unha': 0x814EAF,
		'unha-3': 0xB89FCB,
		'unknown': 0x78433B
	};	

	//	the currently selected test
	var selectedTest = null;
	var previouslySelectedTest = null;	

	//	contains info about what year, what tests, outcomes, missiles, etc that's being visualized
	var selectionData;	
</script>
<script type="text/javascript">
	function start(e) {
	//	detect for webgl and reject everything else
	if (!Detector.webgl) {
		Detector.addGetWebGLMessage();
	} else {
		loadLangCSS(lang);
		//	ensure the map images are loaded first!!
		mapOutlineImage = new Image();
		mapOutlineImage.src = "{{ static_url('images/map_outline.png') }}";
		mapOutlineImage.onload = function() {
			loadDictData(function() {
				document.title = dict['_title'];
				loadFacilityData(function() {
					loadMissileData(function() {
						loadTestData(function() {
							initScene();
							animate();
						});
					});
				});
			});
		};
	};
}
</script>
<script type="text/javascript">
	function loadTestData(callback) {
	//var filePath = 'data/test.' + lang + '.json';
	var filePath = "{{ static_url('data/test.en.json') }}"
	filePath = encodeURI( filePath );
	// console.log(filePath);

	xhr = new XMLHttpRequest();
	xhr.open( 'GET', filePath, true );
	xhr.onreadystatechange = function() {
		if ( xhr.readyState === 4 && xhr.status === 200 ) {
			timeBins = JSON.parse( xhr.responseText ).timeBins;

			maxValue = 0;
			// console.log(timeBins);

			startTime = timeBins[0].year;
			endTime = timeBins[timeBins.length - 1].year;
			timeLength = endTime - startTime;

			if(callback)
				callback();
			console.log("finished read data file");
		}
	};
	xhr.send( null );
}
</script>
<script type="text/javascript">
	function getVisualizedMesh( linearData, year, outcomeCategories, missileCategories ){
	//	pick out the year first from the data
	var indexFromYear = yearIndexLookup[year];

	var affectedTest = [];

	var bin = linearData[indexFromYear].data;

	var linesGeo = new THREE.Geometry();
	var lineColors = [];

	var particlesGeo = new THREE.BufferGeometry();
	var particlePositions = [];
	var particleSizes = [];
	var particleColors = [];

	particlesGeo.vertices = [];

	//	go through the data from year, and find all relevant geometries
	for( i in bin ){
		var set = bin[i];

		var relevantOutcomeCategory = $.inArray(set.outcome, outcomeCategories) >= 0;
		var relevantMissileCategory = $.inArray(set.missile, missileCategories) >= 0;

		if( relevantOutcomeCategory && relevantMissileCategory ){
			//	we may not have line geometry... (?)
			if( set.lineGeometry === undefined )
				continue;

			var lineColor = new THREE.Color(missileColors[set.missile]);

			var lastColor;
			//	grab the colors from the vertices
			for( s in set.lineGeometry.vertices ){
				var v = set.lineGeometry.vertices[s];
				lineColors.push(lineColor);
				lastColor = lineColor;
			}

			//	merge it all together
			linesGeo.merge(set.lineGeometry);

			var particleColor = lastColor.clone();
			var points = set.lineGeometry.vertices;
			var particleCount = 1;
			var particleSize = set.lineGeometry.size * dpr;
			if (set === selectedTest) {
				particleCount *= 4;
				particleSize *= 2;
			}
			for( var rIndex=0; rIndex<points.length-1; rIndex++ ){
				for ( var s=0; s < particleCount; s++ ) {
					var point = points[rIndex];
					var particle = point.clone();
					particle.moveIndex = rIndex;
					particle.nextIndex = rIndex+1;
					if(particle.nextIndex >= points.length )
						particle.nextIndex = 0;
					particle.lerpN = 0;
					particle.path = points;
					particlesGeo.vertices.push( particle );
					particle.size = particleSize;

					particlePositions.push( particle.x, particle.y, particle.z );
					particleSizes.push( particleSize );
					particleColors.push( particleColor.r, particleColor.g, particleColor.b );
				}
			}

			affectedTest.push(set.testName);

			if( set.outcome === 'success' ){
				summary.success[set.missile]++;
				summary.success.total++;
			}
			else if( set.outcome === 'failure' ){
				summary.failure[set.missile]++;
				summary.failure.total++;
			}
			else {
				summary.unknown[set.missile]++;
				summary.unknown.total++;
			}

			summary.total++;

		}
	}

	// console.log(selectedTest);

	linesGeo.colors = lineColors;

	//	make a final mesh out of this composite
	var splineOutline = new THREE.Line( linesGeo, new THREE.LineBasicMaterial(
		{ 	color: 0xffffff, opacity: 1.0, blending:
			THREE.AdditiveBlending, transparent:true,
			depthWrite: false, vertexColors: true,
			linewidth: 1 } )
	);


	particlesGeo.addAttribute('position', new THREE.BufferAttribute(new Float32Array(particlePositions), 3));
	particlesGeo.addAttribute('size', new THREE.BufferAttribute(new Float32Array(particleSizes), 1));
	particlesGeo.addAttribute('customColor', new THREE.BufferAttribute(new Float32Array(particleColors), 3));

	uniforms = {
		amplitude: { type: "f", value: 1.0 },
		color:     { type: "c", value: new THREE.Color( 0xffffff ) },
		texture:   { type: "t", value: new THREE.TextureLoader().load( 
			"{{ static_url('images/particleA.png') }}")},
	};

	var shaderMaterial = new THREE.ShaderMaterial( {

		uniforms:		uniforms,
		vertexShader:	document.getElementById( 'vertexshader' ).textContent,
		fragmentShader:	document.getElementById( 'fragmentshader' ).textContent,

		blending:		THREE.AdditiveBlending,
		depthTest:		true,
		depthWrite:		false,
		transparent:	true,
		// sizeAttenuation: true,
	});



	var pSystem = new THREE.Points( particlesGeo, shaderMaterial );
	pSystem.dynamic = true;
	splineOutline.add( pSystem );

	pSystem.update = function(){
		// var time = Date.now();
		var positionArray = this.geometry.attributes.position.array;
		var index = 0;
		for( var i in this.geometry.vertices ){
			var particle = this.geometry.vertices[i];
			var path = particle.path;
			var moveLength = path.length;

			particle.lerpN += 0.05;
			if(particle.lerpN > 1){
				particle.lerpN = 0;
				particle.moveIndex = particle.nextIndex;
				particle.nextIndex++;
				if( particle.nextIndex >= path.length ){
					particle.moveIndex = 0;
					particle.nextIndex = 1;
				}
			}

			var currentPoint = path[particle.moveIndex];
			var nextPoint = path[particle.nextIndex];


			particle.copy( currentPoint );
			particle.lerp( nextPoint, particle.lerpN );

			positionArray[index++] = particle.x;
			positionArray[index++] = particle.y;
			positionArray[index++] = particle.z;
		}
		this.geometry.attributes.position.needsUpdate = true;
	};

	//	return this info as part of the mesh package, we'll use this in selectvisualization
	splineOutline.affectedTests = affectedTest;


	return splineOutline;
}
</script>
